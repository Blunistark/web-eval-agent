<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operative Control Center</title>
    <link rel="icon" href="https://www.operative.sh/favicon.ico?v=2" type="image/x-icon">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'terminal-bg': '#1C1C1C',
                        'terminal-header': '#2A2A2A',
                        'accent-green': '#27C93F',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', '"Consolas"', '"Menlo"', 'monospace'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-black text-gray-300 font-sans flex flex-col h-screen overflow-hidden">
    <header class="bg-gray-900 border-b border-gray-800 text-white p-3 flex justify-between items-center flex-shrink-0">
        <h1 class="text-lg font-mono font-semibold flex items-center">
            <img src="https://www.operative.sh/favicon.ico?v=2" alt="Operative Favicon" class="h-5 w-5 mr-2 inline-block align-middle">
            <span><a href="https://www.operative.sh" target="_blank" class="hover:underline">Operative Control Center</a></span>
        </h1>
        <div class="flex items-center">
            <span class="mr-2 text-xs">View Mode:</span>
            <button id="view-toggle" class="bg-gray-800 hover:bg-gray-700 text-white text-xs border border-gray-600 rounded-md px-3 py-1 transition-all duration-300">
                <span class="separated-label">Separated</span>
                <span class="joined-label hidden">Joined</span>
            </button>
            <label class="ml-4 flex items-center cursor-pointer">
                <span class="text-xs mr-2">Auto-scroll:</span>
                <div class="relative">
                    <input type="checkbox" id="auto-scroll-toggle" class="sr-only" checked>
                    <div class="block bg-gray-600 w-10 h-5 rounded-full"></div>
                    <div class="dot absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full transition-transform duration-300 transform translate-x-0"></div>
                </div>
            </label>
        </div>
    </header>
    <main id="separated-view" class="container mx-auto px-4 max-w-7xl flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 py-4 overflow-hidden">
        <div class="log-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden">
            <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium">
                <h2 class="text-white">🚦 Agent & Status Logs</h2>
                <button class="copy-button bg-transparent text-white text-xs border border-gray-600 hover:bg-white/10 rounded-md px-2 py-1" data-target="agent-log-container">📋 Copy</button>
            </div>
            <div id="agent-log-container" class="log-container flex-grow overflow-y-auto p-3 font-mono text-xs leading-relaxed"></div>
        </div>
        <div class="log-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden">
            <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium">
                <h2 class="text-white">🖥️ Console Logs</h2>
                <button class="copy-button bg-transparent text-white text-xs border border-gray-600 hover:bg-white/10 rounded-md px-2 py-1" data-target="console-log-container">📋 Copy</button>
            </div>
            <div id="console-log-container" class="log-container flex-grow overflow-y-auto p-3 font-mono text-xs leading-relaxed"></div>
        </div>
        <div class="log-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden">
            <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium">
                <h2 class="text-white">↔️ Network Activity</h2>
                <button class="copy-button bg-transparent text-white text-xs border border-gray-600 hover:bg-white/10 rounded-md px-2 py-1" data-target="network-log-container">📋 Copy</button>
            </div>
            <div id="network-log-container" class="log-container flex-grow overflow-y-auto p-3 font-mono text-xs leading-relaxed"></div>
        </div>
    </main>

    <!-- Socket.IO Client Script -->
    <script>
        // Connect to Socket.IO server (same host/port)
        const socket = io();

        // DOM Elements
        const agentLogEl = document.getElementById('agent-log-container');
        const consoleLogEl = document.getElementById('console-log-container');
        const networkLogEl = document.getElementById('network-log-container');

        // Auto-scroll toggle
        const autoScrollToggle = document.getElementById('auto-scroll-toggle');

        // Helper to append a log line to a container
        function appendLog(el, text) {
            const line = document.createElement('div');
            line.textContent = text;
            el.appendChild(line);
            // Keep the log length reasonable (optional)
            if (el.children.length > 2000) {
                el.firstChild.remove();
            }
            if (autoScrollToggle.checked) {
                el.scrollTop = el.scrollHeight;
            }
        }

        // Receive log messages
        socket.on('log_message', (payload) => {
            if (!payload) return;
            const { data, type } = payload;
            switch (type) {
                case 'console':
                    appendLog(consoleLogEl, data);
                    break;
                case 'network':
                    appendLog(networkLogEl, data);
                    break;
                case 'agent':
                case 'status': // fall-through – status also in agent column
                default:
                    appendLog(agentLogEl, data);
                    break;
            }
        });

        // View toggle: separated vs joined
        const viewToggleBtn = document.getElementById('view-toggle');
        const separatedView = document.getElementById('separated-view');
        let joinedMode = false;
        viewToggleBtn.addEventListener('click', () => {
            joinedMode = !joinedMode;
            if (joinedMode) {
                // show joined – hide other containers and merge logs into agent column
                separatedView.classList.add('hidden');
                document.querySelector('.joined-label').classList.remove('hidden');
                document.querySelector('.separated-label').classList.add('hidden');
            } else {
                separatedView.classList.remove('hidden');
                document.querySelector('.joined-label').classList.add('hidden');
                document.querySelector('.separated-label').classList.remove('hidden');
            }
        });

        // Copy to clipboard buttons
        document.querySelectorAll('.copy-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-target');
                const targetEl = document.getElementById(targetId);
                if (!targetEl) return;
                const text = Array.from(targetEl.children).map(node => node.textContent).join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = '✅ Copied';
                    setTimeout(() => (btn.textContent = '📋 Copy'), 2000);
                }).catch(() => {
                    btn.textContent = '❌ Failed';
                    setTimeout(() => (btn.textContent = '📋 Copy'), 2000);
                });
            });
        });

        console.log('Dashboard script initialised');
    </script>
</body>
</html>