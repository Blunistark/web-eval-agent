<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operative Control Center</title>
    <link rel="icon" href="https://www.operative.sh/favicon.ico?v=2" type="image/x-icon">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'terminal-bg': '#1C1C1C',
                        'terminal-header': '#2A2A2A',
                        'accent-green': '#27C93F',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['"SF Mono"', '"Consolas"', '"Menlo"', 'monospace'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-black text-gray-300 font-sans flex flex-col h-screen overflow-hidden">
    <header class="bg-gray-900 border-b border-gray-800 text-white p-3 flex justify-between items-center flex-shrink-0">
        <h1 class="text-lg font-mono font-semibold flex items-center">
            <img src="https://www.operative.sh/favicon.ico?v=2" alt="Operative Favicon" class="h-5 w-5 mr-2 inline-block align-middle">
            <span><a href="https://www.operative.sh" target="_blank" class="hover:underline">Operative Control Center</a></span>
        </h1>
        <div class="flex items-center space-x-4">
            <!-- Agent Control Buttons -->
            <div class="flex space-x-2">
                <button id="pause-agent-btn" class="bg-yellow-600 hover:bg-yellow-500 text-white text-xs border border-yellow-700 rounded-md px-3 py-1 transition-all duration-300">
                    ‚è∏Ô∏è Pause
                </button>
                <button id="resume-agent-btn" class="bg-green-600 hover:bg-green-500 text-white text-xs border border-green-700 rounded-md px-3 py-1 transition-all duration-300">
                    ‚ñ∂Ô∏è Resume
                </button>
                <button id="stop-agent-btn" class="bg-red-600 hover:bg-red-500 text-white text-xs border border-red-700 rounded-md px-3 py-1 transition-all duration-300">
                    ‚èπÔ∏è Stop
                </button>
            </div>
            
            <!-- View Mode Toggle -->
            <div class="flex items-center">
                <span class="mr-2 text-xs">View Mode:</span>
                <button id="view-toggle" class="bg-gray-800 hover:bg-gray-700 text-white text-xs border border-gray-600 rounded-md px-3 py-1 transition-all duration-300">
                    <span class="separated-label">Separated</span>
                    <span class="joined-label hidden">Joined</span>
                </button>
            </div>
            
            <!-- Auto-scroll Toggle -->
            <label class="flex items-center cursor-pointer">
                <span class="text-xs mr-2">Auto-scroll:</span>
                <div class="relative">
                    <input type="checkbox" id="auto-scroll-toggle" class="sr-only" checked>
                    <div class="block bg-gray-600 w-10 h-5 rounded-full"></div>
                    <div class="dot absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full transition-transform duration-300 transform translate-x-0"></div>
                </div>
            </label>
        </div>
    </header>
    <!-- Changed grid layout: md:grid-cols-2 -->
    <main id="separated-view" class="container mx-auto px-4 max-w-full flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 py-4 overflow-hidden">
        <!-- New Browser View Column -->
        <div class="browser-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden h-full">
             <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium flex-shrink-0">
                <h2 class="text-white">üåê Browser View (Headless)</h2>
                <!-- Add any controls here later if needed -->
            </div>
            <div id="browser-view-container" class="flex-grow overflow-auto p-1 bg-gray-700 flex items-center justify-center">
                 <!-- Image will be updated by JS. Added tabindex to allow focus for keyboard events -->
                <img id="browser-view-img" src="" alt="Browser View" class="max-w-full max-h-full object-contain border border-gray-500 cursor-crosshair" tabindex="0"/>
            </div>
        </div>

        <!-- Log Columns Container (Takes the second grid column on md+) -->
        <div class="logs-wrapper flex flex-col gap-4 overflow-hidden h-full">
            <!-- Agent & Status Logs -->
            <div class="log-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden flex-1">
                 <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium flex-shrink-0">
                    <h2 class="text-white">üö¶ Agent & Status Logs</h2>
                    <button class="copy-button bg-transparent text-white text-xs border border-gray-600 hover:bg-white/10 rounded-md px-2 py-1" data-target="agent-log-container">üìã Copy</button>
                </div>
                <div id="agent-log-container" class="log-container flex-grow overflow-y-auto p-3 font-mono text-xs leading-relaxed"></div>
            </div>
            <!-- Console Logs -->
            <div class="log-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden flex-1">
                 <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium flex-shrink-0">
                    <h2 class="text-white">üñ•Ô∏è Console Logs</h2>
                    <button class="copy-button bg-transparent text-white text-xs border border-gray-600 hover:bg-white/10 rounded-md px-2 py-1" data-target="console-log-container">üìã Copy</button>
                </div>
                <div id="console-log-container" class="log-container flex-grow overflow-y-auto p-3 font-mono text-xs leading-relaxed"></div>
            </div>
            <!-- Network Activity -->
            <div class="log-column bg-terminal-bg border border-gray-800 rounded-2xl flex flex-col overflow-hidden flex-1">
                 <div class="log-header bg-terminal-header border-b border-gray-800 p-3 flex justify-between items-center text-sm font-medium flex-shrink-0">
                    <h2 class="text-white">‚ÜîÔ∏è Network Activity</h2>
                    <button class="copy-button bg-transparent text-white text-xs border border-gray-600 hover:bg-white/10 rounded-md px-2 py-1" data-target="network-log-container">üìã Copy</button>
                </div>
                <div id="network-log-container" class="log-container flex-grow overflow-y-auto p-3 font-mono text-xs leading-relaxed"></div>
            </div>
        </div> <!-- End logs-wrapper -->
    </main>

    <!-- Socket.IO Client Script -->
    <script>
        console.log('Initializing dashboard script...');
        
        // Connect to Socket.IO server (same host/port)
        const socket = io();
        
        // Log socket connection events
        socket.on('connect', () => {
            console.log('SocketIO connected! Socket ID:', socket.id);
        });
        
        socket.on('connect_error', (error) => {
            console.error('SocketIO connection error:', error);
        });
        
        socket.on('disconnect', (reason) => {
            console.warn('SocketIO disconnected! Reason:', reason);
        });

        // DOM Elements
        const agentLogEl = document.getElementById('agent-log-container');
        const consoleLogEl = document.getElementById('console-log-container');
        const networkLogEl = document.getElementById('network-log-container');
        const browserViewImg = document.getElementById('browser-view-img'); // Get browser view image element
        
        console.log('Browser view image element:', browserViewImg ? 'Found' : 'Not found');

        // Auto-scroll toggle
        const autoScrollToggle = document.getElementById('auto-scroll-toggle');

        // Helper to append a log line to a container
        function appendLog(el, text) {
            const line = document.createElement('div');
            line.textContent = text;
            el.appendChild(line);
            // Keep the log length reasonable (optional)
            if (el.children.length > 2000) {
                el.firstChild.remove();
            }
            if (autoScrollToggle.checked) {
                el.scrollTop = el.scrollHeight;
            }
        }

        // Receive log messages
        socket.on('log_message', (payload) => {
            if (!payload) return;
            const { data, type } = payload;
            switch (type) {
                case 'console':
                    appendLog(consoleLogEl, data);
                    break;
                case 'network':
                    appendLog(networkLogEl, data);
                    break;
                case 'agent':
                case 'status': // fall-through ‚Äì status also in agent column
                default:
                    appendLog(agentLogEl, data);
                    break;
            }
        });

        // Receive browser view updates
        socket.on('browser_update', (payload) => {
            console.log('Received browser_update event!', new Date().toISOString());
            
            if (!payload) {
                console.error('browser_update payload is empty or null');
                return;
            }
            
            console.log('browser_update payload:', {
                hasData: !!payload.data,
                dataLength: payload.data ? payload.data.length : 0,
                dataPreview: payload.data ? payload.data.substring(0, 50) + '...' : 'none'
            });
            
            if (!browserViewImg) {
                console.error('browserViewImg element not found when trying to update');
                return;
            }
            
            try {
                browserViewImg.src = payload.data;
                console.log('Updated browserViewImg.src successfully');
                
                // Log when the image actually loads or errors
                browserViewImg.onload = () => {
                    console.log('Browser view image loaded successfully!', 
                        'Size:', browserViewImg.naturalWidth, 'x', browserViewImg.naturalHeight);
                };
                
                browserViewImg.onerror = (error) => {
                    console.error('Browser view image failed to load:', error);
                };
            } catch (error) {
                console.error('Error setting browserViewImg.src:', error);
            }
        });

        // --- Input Event Handling ---
        if (browserViewImg) {
            // Helper to calculate scaled coordinates
            function getScaledCoordinates(event) {
                if (!browserViewImg.naturalWidth || !browserViewImg.naturalHeight) {
                    return null; // Image not loaded yet
                }
                const rect = browserViewImg.getBoundingClientRect();
                const scaleX = browserViewImg.naturalWidth / rect.width;
                const scaleY = browserViewImg.naturalHeight / rect.height;
                // Clamp coordinates to be within the natural bounds
                const x = Math.max(0, Math.min(browserViewImg.naturalWidth, Math.round((event.clientX - rect.left) * scaleX)));
                const y = Math.max(0, Math.min(browserViewImg.naturalHeight, Math.round((event.clientY - rect.top) * scaleY)));
                return { x, y };
            }

            // --- Mouse Click ---
            browserViewImg.addEventListener('click', (event) => {
                console.log("Click event received on browser view image");
                
                // Get image dimensions for debugging
                const imgWidth = browserViewImg.width;
                const imgHeight = browserViewImg.height;
                const naturalWidth = browserViewImg.naturalWidth;
                const naturalHeight = browserViewImg.naturalHeight;
                
                console.log(`Image dimensions: ${imgWidth}x${imgHeight}, Natural: ${naturalWidth}x${naturalHeight}`);
                console.log(`Raw click coordinates: (${event.clientX}, ${event.clientY})`);
                
                const rect = browserViewImg.getBoundingClientRect();
                console.log(`Image position: left=${rect.left}, top=${rect.top}, width=${rect.width}, height=${rect.height}`);
                
                const coords = getScaledCoordinates(event);
                if (!coords) {
                    console.error("Failed to get scaled coordinates - naturalWidth or naturalHeight may be 0");
                    return;
                }

                console.log(`Scaled click coordinates: (${coords.x}, ${coords.y})`);
                
                const buttonName = event.button === 0 ? 'left' : event.button === 1 ? 'middle' : 'right';
                console.log(`Sending click event: button=${buttonName}, clickCount=${event.detail}`);
                
                const inputData = {
                    type: 'click',
                    details: {
                        x: coords.x,
                        y: coords.y,
                        button: buttonName,
                        clickCount: event.detail
                    }
                };
                
                console.log("Emitting browser_input event:", JSON.stringify(inputData));
                socket.emit('browser_input', inputData);
                
                // Log confirmation
                console.log("Click event emitted to server");
                
                // Prevent default browser actions on the image if necessary
                event.preventDefault();
                // Focus the image to capture subsequent key events
                browserViewImg.focus();
            });

            // --- Mouse Wheel (Scroll) ---
            browserViewImg.addEventListener('wheel', (event) => {
                console.log("Wheel event received on browser view image");
                
                const coords = getScaledCoordinates(event);
                if (!coords) {
                    console.error("Failed to get scaled coordinates for wheel event");
                    return;
                }

                console.log(`Wheel event: deltaX=${event.deltaX}, deltaY=${event.deltaY}`);
                console.log(`Scaled wheel coordinates: (${coords.x}, ${coords.y})`);
                
                const inputData = {
                    type: 'scroll',
                    details: {
                        x: coords.x,
                        y: coords.y,
                        deltaX: event.deltaX,
                        deltaY: event.deltaY
                    }
                };
                
                console.log("Emitting browser_input event for scroll:", JSON.stringify(inputData));
                socket.emit('browser_input', inputData);
                console.log("Scroll event emitted to server");
                
                // Prevent page scroll while interacting with the browser view
                event.preventDefault();
            });

            // --- Keyboard Input ---
            // Need to capture on the image itself after it's focused (e.g., by clicking)
            browserViewImg.addEventListener('keydown', (event) => {
                console.log(`KeyDown: Key=${event.key}, Code=${event.code}, Modifiers(A/C/M/S):${event.altKey}/${event.ctrlKey}/${event.metaKey}/${event.shiftKey}`);
                socket.emit('browser_input', {
                    type: 'keydown',
                    details: {
                        key: event.key,
                        code: event.code,
                        altKey: event.altKey,
                        ctrlKey: event.ctrlKey,
                        metaKey: event.metaKey,
                        shiftKey: event.shiftKey
                    }
                });
                 // Prevent default browser actions for keys if needed (e.g., arrow keys scrolling page)
                 // Be careful not to block essential browser shortcuts unless intended.
                 if (!event.metaKey && !event.ctrlKey && !event.altKey) { // Allow browser shortcuts
                    event.preventDefault();
                 }
            });

            browserViewImg.addEventListener('keyup', (event) => {
                 console.log(`KeyUp: Key=${event.key}, Code=${event.code}`);
                 socket.emit('browser_input', {
                    type: 'keyup',
                    details: {
                         key: event.key,
                         code: event.code,
                         altKey: event.altKey,
                         ctrlKey: event.ctrlKey,
                         metaKey: event.metaKey,
                         shiftKey: event.shiftKey
                    }
                 });
                 if (!event.metaKey && !event.ctrlKey && !event.altKey) {
                    event.preventDefault();
                 }
            });

            // TODO: Potentially add 'mousemove' if needed, but it can be very noisy.
            // TODO: Consider 'mousedown' and 'mouseup' separately if 'click' isn't sufficient (e.g., for dragging).
        }


        // View toggle: separated vs joined (Keep existing functionality)
        const viewToggleBtn = document.getElementById('view-toggle');
        const separatedView = document.getElementById('separated-view');
        // Note: This toggle might need adjustment depending on how the browser view should behave in "joined" mode.
        // For now, it will just hide/show the main grid containing browser + logs.
        let joinedMode = false;
        viewToggleBtn.addEventListener('click', () => {
            joinedMode = !joinedMode;
            if (joinedMode) {
                separatedView.classList.add('hidden'); // Hides the whole grid
                document.querySelector('.joined-label').classList.remove('hidden');
                document.querySelector('.separated-label').classList.add('hidden');
                // TODO: Implement a proper "joined" view if needed, maybe showing logs below browser?
            } else {
                separatedView.classList.remove('hidden'); // Shows the grid again
                document.querySelector('.joined-label').classList.add('hidden');
                document.querySelector('.separated-label').classList.remove('hidden');
            }
        });

        // Copy to clipboard buttons (Keep existing functionality)
        document.querySelectorAll('.copy-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-target');
                const targetEl = document.getElementById(targetId);
                if (!targetEl) return;
                const text = Array.from(targetEl.children).map(node => node.textContent).join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = '‚úÖ Copied';
                    setTimeout(() => (btn.textContent = 'üìã Copy'), 2000);
                }).catch(() => {
                    btn.textContent = '‚ùå Failed';
                    setTimeout(() => (btn.textContent = 'üìã Copy'), 2000);
                });
            });
        });

        // Agent control buttons
        const pauseAgentBtn = document.getElementById('pause-agent-btn');
        const resumeAgentBtn = document.getElementById('resume-agent-btn');
        const stopAgentBtn = document.getElementById('stop-agent-btn');
        
        // Add event listeners for agent control buttons
        pauseAgentBtn.addEventListener('click', () => {
            console.log('Pause agent button clicked');
            socket.emit('agent_control', { action: 'pause' });
            appendLog(agentLogEl, "‚è∏Ô∏è Pause agent requested");
        });
        
        resumeAgentBtn.addEventListener('click', () => {
            console.log('Resume agent button clicked');
            socket.emit('agent_control', { action: 'resume' });
            appendLog(agentLogEl, "‚ñ∂Ô∏è Resume agent requested");
        });
        
        stopAgentBtn.addEventListener('click', () => {
            console.log('Stop agent button clicked');
            socket.emit('agent_control', { action: 'stop' });
            appendLog(agentLogEl, "‚èπÔ∏è Stop agent requested");
        });
        
        // Receive agent state updates
        socket.on('agent_state', (payload) => {
            console.log('Received agent_state event:', payload);
            if (payload && payload.state) {
                const { paused, stopped } = payload.state;
                
                // Update button states based on agent state
                pauseAgentBtn.disabled = paused || stopped;
                pauseAgentBtn.classList.toggle('opacity-50', paused || stopped);
                
                resumeAgentBtn.disabled = !paused || stopped;
                resumeAgentBtn.classList.toggle('opacity-50', !paused || stopped);
                
                stopAgentBtn.disabled = stopped;
                stopAgentBtn.classList.toggle('opacity-50', stopped);
                
                // Add visual indication of current state
                if (stopped) {
                    appendLog(agentLogEl, "‚èπÔ∏è Agent is stopped");
                } else if (paused) {
                    appendLog(agentLogEl, "‚è∏Ô∏è Agent is paused");
                } else {
                    appendLog(agentLogEl, "‚ñ∂Ô∏è Agent is running");
                }
            }
        });
        
        console.log('Dashboard script initialised');
    </script>
</body>
</html>
